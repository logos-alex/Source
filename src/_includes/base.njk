<!DOCTYPE html>
<html lang="he" dir="rtl" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} | ××•×¦×¨ ×”×›×ª×‘×™× ×”×’× ×•×–×™×</title>
    
    <!-- Accessibility -->
    <meta name="color-scheme" content="light dark">
    
    <!-- SEO & Meta Tags -->
    <meta name="description" content="{% if description %}{{ description }}{% else %}××¡×¢ ××œ ×”×›×ª×‘×™× ×”×’× ×•×–×™× ×•×”××‘×•×“×™× ×©×œ ×”××¡×•×¨×ª ×”×™×”×•×“×™×ª. ×ª×¨×’×•××™×, ×‘×™××•×¨×™× ×•×¢×™×•×Ÿ ×‘×˜×§×¡×˜×™× ×©× ×“×—×§×• ××œ ×”×©×•×œ×™×™×.{% endif %}">
    <meta name="keywords" content="×›×ª×‘×™× ×’× ×•×–×™×, ××¤×•×§×¨×™×¤×”, ×¡×¤×¨×™× ×—×™×¦×•× ×™×™×, ×™×”×“×•×ª, ×‘×™×ª ×©× ×™, ××™× ×•×ª, ×’× ×•×¡×˜×™×§×”, ×§×‘×œ×”, ××™×¡×˜×™×§×”, ×“× ×™××œ, ××‘×¨×”×, ×–×¨×•×‘×‘×œ, ×¢×–×¨×, ×™×©×¢×™×”×•, ××œ×™×”×•">
    <meta name="author" content="×‘×™×ª ×”××“×¨×© ×”×•×•×™×¨×˜×•××œ×™">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://heb-sources.netlify.app{{ page.url }}">
    
    <!-- Open Graph Tags for Social Media -->
    <meta property="og:type" content="{% if pageNumber == 0 %}book{% else %}article{% endif %}">
    <meta property="og:title" content="{{ title }} | ××•×¦×¨ ×”×›×ª×‘×™× ×”×’× ×•×–×™×">
    <meta property="og:description" content="{% if description %}{{ description }}{% else %}××¡×¢ ××œ ×”×›×ª×‘×™× ×”×’× ×•×–×™× ×•×”××‘×•×“×™× ×©×œ ×”××¡×•×¨×ª ×”×™×”×•×“×™×ª. ×ª×¨×’×•××™×, ×‘×™××•×¨×™× ×•×¢×™×•×Ÿ ×‘×˜×§×¡×˜×™× ×©× ×“×—×§×• ××œ ×”×©×•×œ×™×™×.{% endif %}">
    <meta property="og:url" content="https://heb-sources.netlify.app{{ page.url }}">
    <meta property="og:site_name" content="××•×¦×¨ ×”×›×ª×‘×™× ×”×’× ×•×–×™×">
    <meta property="og:locale" content="he_IL">
    <meta property="og:image" content="{% if ogImage %}{{ ogImage }}{% else %}https://heb-sources.netlify.app/assets/og-image.svg{% endif %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="××•×¦×¨ ×”×›×ª×‘×™× ×”×’× ×•×–×™× - ×××’×¨ ×“×™×’×™×˜×œ×™ ×œ×›×ª×‘×™× ××¤×•×§×¨×™×¤×™×™×">

    <!-- Twitter/X Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ title }} | ××•×¦×¨ ×”×›×ª×‘×™× ×”×’× ×•×–×™×">
    <meta name="twitter:description" content="{% if description %}{{ description }}{% else %}××¡×¢ ××œ ×”×›×ª×‘×™× ×”×’× ×•×–×™× ×•×”××‘×•×“×™× ×©×œ ×”××¡×•×¨×ª ×”×™×”×•×“×™×ª. ×ª×¨×’×•××™×, ×‘×™××•×¨×™× ×•×¢×™×•×Ÿ ×‘×˜×§×¡×˜×™× ×©× ×“×—×§×• ××œ ×”×©×•×œ×™×™×.{% endif %}">
    <meta name="twitter:image" content="{% if ogImage %}{{ ogImage }}{% else %}https://heb-sources.netlify.app/assets/og-image.svg{% endif %}">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "{% if pageNumber == 0 %}Book{% else %}Article{% endif %}",
      "name": "{{ title }}",
      "description": "{% if description %}{{ description }}{% else %}××¡×¢ ××œ ×”×›×ª×‘×™× ×”×’× ×•×–×™× ×•×”××‘×•×“×™× ×©×œ ×”××¡×•×¨×ª ×”×™×”×•×“×™×ª. ×ª×¨×’×•××™×, ×‘×™××•×¨×™× ×•×¢×™×•×Ÿ ×‘×˜×§×¡×˜×™× ×©× ×“×—×§×• ××œ ×”×©×•×œ×™×™×.{% endif %}",
      "url": "https://heb-sources.netlify.app{{ page.url }}",
      "inLanguage": "he",
      "author": {
        "@type": "Organization",
        "name": "××•×¦×¨ ×”×›×ª×‘×™× ×”×’× ×•×–×™×"
      }
    }
    </script>
    
    {# --- ×”×•×¡×¤×ª ×”×’×•×¤×Ÿ ×”××©×•×¤×¨ ×-Google Fonts --- #}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300;400;700&family=Noto+Serif+Hebrew:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ '/assets/style.css' | url }}">
</head>
<body class="{{ bodyClass }}">
    <a class="skip-link" href="#main-content">×“×œ×’ ×œ×ª×•×›×Ÿ</a>
    <button id="readingModeToggle" class="reading-mode-toggle" type="button" aria-pressed="false" aria-label="××¦×‘ ×§×¨×™××” - ×”×¡×ª×¨ × ×™×•×•×˜ ×•×›×•×ª×¨×•×ª">
        <span aria-hidden="true">ğŸ“–</span>
    </button>
    <script>
        (function() {
            const toggleButton = document.getElementById('readingModeToggle');
            const storedReadingMode = localStorage.getItem('readingMode') === 'true';

            if (storedReadingMode) {
                document.body.classList.add('reading-mode');
            }

            if (toggleButton) {
                toggleButton.setAttribute('aria-pressed', String(storedReadingMode));
                toggleButton.addEventListener('click', function() {
                    document.body.classList.toggle('reading-mode');
                    const isReading = document.body.classList.contains('reading-mode');
                    localStorage.setItem('readingMode', isReading);
                    toggleButton.setAttribute('aria-pressed', String(isReading));
                });
            }
        })();
    </script>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "ucq1c77qd5");
    </script>

    {# --- Google Analytics (GA4) --- #}
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M3NHG4MWVR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-M3NHG4MWVR');
    </script>
    <header>
        <div class="header-top">
            <button class="mobile-nav-toggle" id="mobileNavToggle" aria-label="×¤×ª×— ×ª×¤×¨×™×˜ × ×™×•×•×˜" aria-expanded="false" aria-controls="main-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1><a href="/">××•×¦×¨ ×”×›×ª×‘×™× ×”×’× ×•×–×™×</a></h1>
            <button id="themeToggle" class="theme-toggle" aria-label="×”×—×œ×£ ×œ××¦×‘ ×›×”×”" aria-pressed="false">
                <span aria-hidden="true">ğŸŒ™</span>
            </button>
        </div>
        <nav role="navigation" aria-label="× ×™×•×•×˜ ×¨××©×™" id="main-nav">
            <a href="/" {% if page.url == "/" %}aria-current="page"{% endif %}>×“×£ ×”×‘×™×ª</a>
            <a href="/search/" {% if page.url == "/search/" %}aria-current="page"{% endif %} aria-label="×—×™×¤×•×© ×‘××ª×¨"><span aria-hidden="true">ğŸ”</span> ×—×™×¤×•×©</a>

            <div class="nav-dropdown" data-dropdown>
                <a href="/texts/" class="dropbtn" {% if page.url and page.url.startsWith("/texts/") %}aria-current="page"{% endif %} aria-expanded="false" aria-haspopup="true">×œ×¤×™ ××§×•×¨</a>
                <div class="dropdown-content" role="menu">
                    <a href="/texts/hebrew/" role="menuitem" {% if page.url == "/texts/hebrew/" %}aria-current="page"{% endif %}>×¢×‘×¨×™×ª</a>
                    <a href="/texts/slavic/" role="menuitem" {% if page.url == "/texts/slavic/" %}aria-current="page"{% endif %}>×¡×œ××‘×™×ª</a>
                    <a href="/texts/aramaic/" role="menuitem" {% if page.url == "/texts/aramaic/" %}aria-current="page"{% endif %}>××¨××™×ª</a>
                </div>
            </div>

            <div class="nav-dropdown" data-dropdown>
                <a href="/by-figure/" class="dropbtn" {% if page.url and page.url.startsWith("/by-figure/") %}aria-current="page"{% endif %} aria-expanded="false" aria-haspopup="true">×œ×¤×™ ×™×—×•×¡</a>
                <div class="dropdown-content" role="menu">
                    <a href="/by-figure/abraham/" role="menuitem" {% if page.url == "/by-figure/abraham/" %}aria-current="page"{% endif %}>××‘×¨×”×</a>
                    <a href="/by-figure/daniel/" role="menuitem" {% if page.url == "/by-figure/daniel/" %}aria-current="page"{% endif %}>×“× ×™××œ</a>
                    <a href="/by-figure/zerubbabel/" role="menuitem" {% if page.url == "/by-figure/zerubbabel/" %}aria-current="page"{% endif %}>×–×¨×•×‘×‘×œ</a>
                </div>
            </div>
        </nav>
        {% include "breadcrumbs.njk" %}
    </header>
    
    <main id="main-content" role="main">
        {% block content %}
            {{ content | safe }}
        {% endblock %}
    </main>
    <footer>
        <div id="google_translate_element"></div>
        <p>&copy; ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª - 2025</p>
        <p class="footer-links">
            <a href="/sitemap.xml">Sitemap</a> |
            <a href="/robots.txt">Robots</a>
        </p>
    </footer>

    <!-- Dark Mode Script -->
    <script>
      (function() {
        const htmlRoot = document.getElementById('htmlRoot');
        const themeToggle = document.getElementById('themeToggle');

        // Check stored preference or system preference
        function initTheme() {
          const stored = localStorage.getItem('theme');
          const prefer = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
          const theme = stored || prefer;
          applyTheme(theme);
        }

        function applyTheme(theme) {
          const isDark = theme === 'dark';
          if (isDark) {
            htmlRoot.setAttribute('data-theme', 'dark');
            if (themeToggle) {
              themeToggle.querySelector('span').textContent = 'â˜€ï¸';
              themeToggle.setAttribute('aria-label', '×”×—×œ×£ ×œ××¦×‘ ×‘×”×™×¨');
            }
          } else {
            htmlRoot.removeAttribute('data-theme');
            if (themeToggle) {
              themeToggle.querySelector('span').textContent = 'ğŸŒ™';
              themeToggle.setAttribute('aria-label', '×”×—×œ×£ ×œ××¦×‘ ×›×”×”');
            }
          }
          if (themeToggle) {
            themeToggle.setAttribute('aria-pressed', String(isDark));
          }
          localStorage.setItem('theme', theme);
        }

        if (themeToggle) {
          themeToggle.addEventListener('click', function() {
            const current = htmlRoot.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
          });
        }

        initTheme();
      })();
    </script>

    <!-- Accessible Dropdown Navigation -->
    <script>
      (function() {
        const dropdowns = document.querySelectorAll('[data-dropdown]');

        dropdowns.forEach(function(dropdown) {
          const button = dropdown.querySelector('.dropbtn');
          const menu = dropdown.querySelector('.dropdown-content');
          const menuItems = menu.querySelectorAll('a');

          // Toggle dropdown on click
          button.addEventListener('click', function(e) {
            e.preventDefault();
            const isOpen = dropdown.classList.contains('open');
            // Close all other dropdowns
            dropdowns.forEach(function(d) {
              d.classList.remove('open');
              d.querySelector('.dropbtn').setAttribute('aria-expanded', 'false');
            });
            // Toggle current dropdown
            if (!isOpen) {
              dropdown.classList.add('open');
              button.setAttribute('aria-expanded', 'true');
              menuItems[0].focus();
            }
          });

          // Keyboard navigation
          button.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
              e.preventDefault();
              dropdown.classList.add('open');
              button.setAttribute('aria-expanded', 'true');
              menuItems[0].focus();
            }
          });

          menuItems.forEach(function(item, index) {
            item.addEventListener('keydown', function(e) {
              if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (index < menuItems.length - 1) {
                  menuItems[index + 1].focus();
                }
              } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (index > 0) {
                  menuItems[index - 1].focus();
                } else {
                  button.focus();
                }
              } else if (e.key === 'Escape') {
                dropdown.classList.remove('open');
                button.setAttribute('aria-expanded', 'false');
                button.focus();
              } else if (e.key === 'Tab' && !e.shiftKey && index === menuItems.length - 1) {
                dropdown.classList.remove('open');
                button.setAttribute('aria-expanded', 'false');
              }
            });
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', function(e) {
            if (!dropdown.contains(e.target)) {
              dropdown.classList.remove('open');
              button.setAttribute('aria-expanded', 'false');
            }
          });
        });

        // Mobile Navigation Toggle
        const mobileToggle = document.getElementById('mobileNavToggle');
        const mainNav = document.getElementById('main-nav');

        if (mobileToggle && mainNav) {
          mobileToggle.addEventListener('click', function() {
            const isOpen = mainNav.classList.toggle('mobile-open');
            mobileToggle.classList.toggle('active');
            mobileToggle.setAttribute('aria-expanded', String(isOpen));
            mobileToggle.setAttribute('aria-label', isOpen ? '×¡×’×•×¨ ×ª×¤×¨×™×˜ × ×™×•×•×˜' : '×¤×ª×— ×ª×¤×¨×™×˜ × ×™×•×•×˜');
          });

          // Close mobile menu when link clicked
          mainNav.querySelectorAll('a:not(.dropbtn)').forEach(function(link) {
            link.addEventListener('click', function() {
              mainNav.classList.remove('mobile-open');
              mobileToggle.classList.remove('active');
              mobileToggle.setAttribute('aria-expanded', 'false');
              mobileToggle.setAttribute('aria-label', '×¤×ª×— ×ª×¤×¨×™×˜ × ×™×•×•×˜');
            });
          });
        }
      })();
    </script>

    <!-- Google Translate - Deferred Loading -->
    <script>
      (function() {
        // Only load Google Translate when user scrolls to footer area
        var translateLoaded = false;
        function loadGoogleTranslate() {
          if (translateLoaded) return;
          translateLoaded = true;

          window.googleTranslateElementInit = function() {
            new google.translate.TranslateElement({
              pageLanguage: 'he',
              includedLanguages: 'en,fr,de,es,ru,ar,it',
              layout: google.translate.TranslateElement.InlineLayout.SIMPLE
            }, 'google_translate_element');
          };

          var script = document.createElement('script');
          script.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
          script.async = true;
          document.body.appendChild(script);
        }

        // Use Intersection Observer to load when footer becomes visible
        var translateElement = document.getElementById('google_translate_element');
        if (translateElement && 'IntersectionObserver' in window) {
          var observer = new IntersectionObserver(function(entries) {
            if (entries[0].isIntersecting) {
              loadGoogleTranslate();
              observer.disconnect();
            }
          }, { rootMargin: '200px' });
          observer.observe(translateElement);
        } else {
          // Fallback: load after page load
          window.addEventListener('load', loadGoogleTranslate);
        }
      })();
    </script>

</body>
</html>
