{% extends "base.njk" %}

{% block content %}
  <!-- Reading Progress Bar -->
  <div class="reading-progress">
    <div class="reading-progress-bar" id="readingProgress"></div>
  </div>
  
  <div class="text-main" data-pagefind-body>
    <h1 data-pagefind-meta="title">{{ title }}</h1>
    
    {% if source or figure %}
      {% set sourceHebrew = sources[source] or source %}
      {% set figureHebrew = figures[figure] or figure %}
      <p><em>××§×•×¨: {{ sourceHebrew or '×œ× ××¦×•×™×Ÿ' }} | ×™×—×•×¡: {{ figureHebrew or '×œ× ××¦×•×™×Ÿ' }}</em></p>
    {% endif %}
    
    <div class="text-content {% if book == 'apoc-daniel-syriac' and pageNumber != 0 %}parallel-layout{% endif %}">
      {% if book == "apoc-daniel-syriac" and pageNumber != 0 %}
        {% set contentParts = content.split("### ×ª×¨×’×•× ×¢×‘×¨×™") %}
        <div class="column-source">
          {{ contentParts[0] | replace("### ××§×•×¨ ××¨××™", "") | safe }}
        </div>
        <div class="column-translation">
          {{ contentParts[1] | safe }}
        </div>
      {% else %}
        {{ content | safe }}
      {% endif %}
    </div>
  </div>
  
  <script>
    window.addEventListener('scroll', function() {
      const windowHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (window.scrollY / windowHeight) * 100;
      const progressEl = document.getElementById('readingProgress');
      if (progressEl) {
        progressEl.style.width = scrolled + '%';
      }
    });
  </script>

  {% if pageNumber != 0 %}
    <div class="footnotes">
      <h3>×”×¢×¨×•×ª ×•×‘×™××•×¨×™×</h3>
      <ol>
        {% for note in notes %}
          <li id="note-{{ loop.index }}">{{ note | safe }}</li>
        {% endfor %}
      </ol>
    </div>
  {% endif %}

  {# --- × ×™×•×•×˜ ×‘×™×Ÿ ×¢××•×“×™× (×¢× ×›×¤×ª×•×¨ ×—×–×¨×” ×œ×ª×•×›×Ÿ ×”×¢× ×™×™× ×™×) --- #}
  {# Construct the collection name dynamically from the book and version #}
  {% set collectionName = book + '-' + version %}
  {% set pagesInBook = collections[collectionName] %}
  {% set currentPageIndex = pagesInBook | findIndexByUrl(page.url) %}
  
  <nav class="pagination">
    {# ×›×¤×ª×•×¨ "×”×§×•×“×" (××•×¤×™×¢ ××™××™×Ÿ) - ×¦×¨×™×š ×—×¥ ×™××™× ×” #}
    {% if currentPageIndex > 0 %}
      {% set prevPage = pagesInBook[currentPageIndex - 1] %}
      <a href="{{ prevPage.url | url }}" class="prev">â†’ {{ prevPage.data.title }}</a>
    {% endif %}

    {# === ×›×¤×ª×•×¨ ×ª×•×›×Ÿ ×”×¢× ×™×™× ×™× (×ª××™×“ ××•×¤×™×¢ ×‘× ×™×•×•×˜ ×”×§×‘×•×¢) === #}
    {% if book %}
    <div class="toc-dropdown">
      <a href="{{ pagesInBook[0].url | url }}" class="home-link">ğŸ“– ×ª×•×›×Ÿ ×”×¢× ×™×™× ×™×</a>
      <div class="toc-dropdown-content">
        <div class="toc-dropdown-header">×¤×¨×§×™× ×‘×˜×§×¡×˜</div>
        <ol>
          {% for item in pagesInBook %}
            {% if item.data.pageNumber != 0 %}
              <li><a href="{{ item.url | url }}">{{ item.data.title }}</a></li>
            {% endif %}
          {% endfor %}
        </ol>
      </div>
    </div>
    {% endif %}
    
    {# ×›×¤×ª×•×¨ "×”×‘×" (××•×¤×™×¢ ××©×××œ) - ×¦×¨×™×š ×—×¥ ×©×××œ×” #}
    {% if currentPageIndex < pagesInBook.length - 1 %}
      {% set nextPage = pagesInBook[currentPageIndex + 1] %}
      <a href="{{ nextPage.url | url }}" class="next">â† {{ nextPage.data.title }}</a>
    {% endif %}
  </nav>

  {# --- ××–×•×¨ ×”×ª×’×•×‘×•×ª ×©×œ Disqus --- #}
  <div id="comments-section" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
    <h3>×ª×’×•×‘×•×ª</h3>
    <div id="disqus_thread"></div>
    <script>
        (function() {
            try {
                var disqus_config = function () {
                    this.page.url = "https://heb-sources.netlify.app{{ page.url | url }}";
                    this.page.identifier = "{{ page.url | url }}";
                };
                var d = document, s = d.createElement('script');
                s.src = 'https://hebrew-aramaic-sources.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                s.onerror = function() { console.log('Disqus loading handled'); };
                (d.head || d.body).appendChild(s);
            } catch(e) {
                console.log('Disqus error handled');
            }
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>

{% endblock %}
