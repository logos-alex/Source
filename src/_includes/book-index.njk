{% extends "base.njk" %}

{% block content %}
  <div class="text-main">
    {# מציג את הכותרת ואת תוכן המבוא עצמו #}
    <h1>{{ title }}</h1>
    {% if source or figure %}
      {% set sourceHebrew = sources[source] or source %}
      {% set figureHebrew = figures[figure] or figure %}
      <p><em>מקור: {{ sourceHebrew or 'לא מצוין' }} | יחוס: {{ figureHebrew or 'לא מצוין' }}</em></p>
    {% endif %}
    {{ content | safe }}
  </div>

  {# --- תוכן העניינים האוטומטי עבור ספרים ללא תוכן ידני --- #}
  <div class="table-of-contents" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
    <h3>העמודים:</h3>
    
    {# --- הפרדה לנוסחים שונים --- #}
    {% set lastVersion = 'none' %}
    <ul>
    {% for pageItem in collections.textsByBook[book] %}
      {% if pageItem.data.pageNumber > 0 %}
        {% if pageItem.url.includes('/a/') %}
          {% if lastVersion !== 'a' %}
            {% if lastVersion !== 'none' %}</ul><div style="height: 20px; border-top: 1px solid var(--border-color); margin: 15px 0;"></div><h4 style="margin: 10px 0 10px 0; color: var(--header-color);">נוסח ב'</h4><ul>{% endif %}
            {% set lastVersion = 'a' %}
          {% endif %}
        {% elif pageItem.url.includes('/b/') %}
          {% if lastVersion !== 'b' %}
            </ul><div style="height: 20px; border-top: 1px solid var(--border-color); margin: 15px 0;"></div><h4 style="margin: 10px 0 10px 0; color: var(--header-color);">נוסח ב'</h4><ul>
            {% set lastVersion = 'b' %}
          {% endif %}
        {% endif %}
        
        <li>
          <a href="{{ pageItem.url | url }}">
            {{ pageItem.data.title }}
          </a>
        </li>
      {% endif %}
    {% endfor %}
    </ul>
  </div>

  {# --- אזור התגובות של Disqus --- #}
  <div id="comments-section" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
    <h3>תגובות</h3>
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = "https://heb-sources.netlify.app{{ page.url | url }}";
            this.page.identifier = "{{ page.url | url }}";
        };
        (function() {
            var d = document, s = d.createElement('script');
            s.src = 'https://hebrew-aramaic-sources.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
{% endblock %}
